<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>הגדרות מיתוג</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>

<header class="topbar">
  <div class="topbar-inner">
    <div class="brand-left">
      <div class="brand-logo">
        <img data-brand="logo" alt="לוגו">
        <span class="fallback" data-brand="logoFallback">LOGO</span>
      </div>
      <div class="brand-text">
        <h1 data-brand="groupName">המסע המשותף שלנו</h1>
        <div class="tagline" data-brand="tagline">מיתוג לחוברת ולמערכת</div>
      </div>
    </div>

    <div class="actions">
      <a class="btn ghost" href="index.html">חזרה</a>
      <a class="btn" href="booklet.html">חוברת להדפסה</a>
    </div>
  </div>
</header>

<main class="container">

  <section class="card">
    <h2 style="margin-top:0;">הגדרות מיתוג לארגון</h2>
    <p class="muted">כאן ניתן לשנות שם קבוצה, שורת משנה ולוגו. הלוגו יופיע באתר ובחוברת.</p>

    <label class="lbl">שם הקבוצה</label>
    <input id="groupName" class="input" type="text" placeholder="שם הקבוצה" />

    <label class="lbl">שורת משנה</label>
    <input id="tagline" class="input" type="text" placeholder="שורת משנה" />

    <label class="lbl">לוגו (JPG/PNG)</label>
    <input id="logoFile" type="file" accept="image/*" />

    <div class="preview">
      <div class="muted small">תצוגה מקדימה:</div>
      <img id="previewImg" alt="preview" />
    </div>

    <div class="actions" style="margin-top:14px;">
      <button id="saveBtn" class="btn">שמור</button>
      <button id="resetBtn" class="btn secondary">איפוס</button>
    </div>

    <div id="msg" class="muted small" style="margin-top:10px;"></div>
  </section>

  <section class="card">
    <h2 style="margin-top:0;">בדיקת לוגו ברירת מחדל</h2>
    <p class="muted small">אם הלוגו ברירת המחדל לא נטען, פתח/י את הקישור הזה ובדקי שאין 404:</p>
    <div class="breakall" id="defaultUrl"></div>
  </section>

</main>

<script src="brand.js"></script>
<script>
  function setMsg(t){ document.getElementById("msg").textContent = t; }

  // מקטין תמונה כדי שתיכנס ל-localStorage בלי להיכשל
  async function compressToDataURL(file, maxSize=420, quality=0.82){
    const img = new Image();
    const dataUrl = await new Promise((resolve, reject) => {
      const r = new FileReader();
      r.onload = () => resolve(r.result);
      r.onerror = reject;
      r.readAsDataURL(file);
    });
    img.src = dataUrl;
    await new Promise((res, rej) => { img.onload=res; img.onerror=rej; });

    const canvas = document.createElement("canvas");
    const ctx = canvas.getContext("2d");

    const scale = Math.min(1, maxSize / Math.max(img.width, img.height));
    canvas.width = Math.round(img.width * scale);
    canvas.height = Math.round(img.height * scale);

    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
    return canvas.toDataURL("image/jpeg", quality);
  }

  // רינדור ראשוני
  const b = brandRender();

  const groupName = document.getElementById("groupName");
  const tagline   = document.getElementById("tagline");
  const logoFile  = document.getElementById("logoFile");
  const preview   = document.getElementById("previewImg");

  groupName.value = b.groupName;
  tagline.value = b.tagline;

  // ברירת מחדל לוגו - נציג את ה-URL המחושב
  const base = window.location.origin + "/" + window.location.pathname.split("/")[1] + "/";
  document.getElementById("defaultUrl").textContent = base + "assets/ourway.jpg";

  // Preview כשבוחרים קובץ
  logoFile.addEventListener("change", async () => {
    if (!logoFile.files || !logoFile.files[0]) return;
    try{
      setMsg("מכין תצוגה מקדימה...");
      const smallData = await compressToDataURL(logoFile.files[0]);
      preview.src = smallData;
      preview.style.display = "block";
      setMsg("מוכן. לחצי 'שמור' כדי להחיל על האתר.");
    }catch(e){
      setMsg("שגיאה בקריאת הקובץ. נסי JPG/PNG קטן יותר.");
    }
  });

  document.getElementById("saveBtn").addEventListener("click", async () => {
    try{
      const next = brandLoad();
      next.groupName = groupName.value.trim() || next.groupName;
      next.tagline   = tagline.value.trim() || next.tagline;

      if (logoFile.files && logoFile.files[0]) {
        setMsg("דוחס ושומר את הלוגו...");
        next.logoDataUrl = await compressToDataURL(logoFile.files[0]);
      }

      brandSave(next);
      brandRender();
      setMsg("נשמר בהצלחה. עברי לעמוד הבית/חוברת ובדקי.");
    }catch(e){
      setMsg("לא הצליח לשמור (יתכן שהקובץ גדול מדי). נסי תמונה קטנה יותר.");
    }
  });

  document.getElementById("resetBtn").addEventListener("click", () => {
    brandReset();
    const n = brandLoad();
    groupName.value = n.groupName;
    tagline.value = n.tagline;
    logoFile.value = "";
    preview.removeAttribute("src");
    preview.style.display = "none";
    brandRender();
    setMsg("אופס. בוצע איפוס. כעת אמור להופיע לוגו ברירת המחדל (assets/ourway.jpg).");
  });
</script>

</body>
</html>
