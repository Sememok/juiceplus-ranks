<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>专 砖</title>
  <link rel="stylesheet" href="style.css?v=D3_ENGINE" />
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    /* 注爪 砖 拽爪注 */
    .calc-card {
      background: white;
      border: 2px solid #e2e8f0;
      padding: 25px;
      margin-top: 20px;
      border-radius: 15px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    }
    .calc-header { font-size: 1.4rem; font-weight: 800; color: #1e293b; margin-bottom: 15px; }
    .calc-row { display: flex; gap: 15px; margin-bottom: 15px; flex-wrap: wrap; }
    .calc-input { flex: 1; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 1rem; }
    .calc-btn { 
      background: #10b981; color: white; padding: 12px 30px; 
      border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 1rem;
    }
    .calc-btn:hover { background: #059669; }
    .calc-result { 
      background: #f0fdf4; border: 1px solid #bbf7d0; 
      padding: 20px; border-radius: 10px; margin-top: 20px; 
      display: none; /* 住转专 */
    }
    .res-number { font-size: 2.5rem; font-weight: 800; color: #15803d; line-height: 1.2; }
    .res-text { font-size: 1.1rem; color: #166534; }
  </style>
</head>

<body>
  <header class="topbar">
    <div class="topbar-inner">
      <div class="brand-left">
        <a class="btn ghost" href="index.html">专 专砖</a>
        <a class="btn primary" href="products.html" style="background-color:#ff6b00; margin-right:10px;">拽 爪专 </a>
      </div>
      <div class="brand-center">
        <div class="brand-title">住注 砖转祝 砖</div>
      </div>
    </div>
  </header>

  <main class="container">
    <nav class="rank-nav-container">
      <div class="rank-nav-label">专 专:</div>
      <div id="rankNav" class="rank-nav-buttons"></div>
    </nav>

    <div id="rankPrintLayout">
      <div class="rank-text-area">
        <section class="card">
          <h1 id="rankTitle" class="rankTitle">注...</h1>
          <p id="rankIntro" class="rankIntro"></p>
        </section>

        <section class="calc-card no-print" id="calculatorSection">
          <div class="calc-header">М 砖 住专 住专转 专</div>
          <div style="margin-bottom:15px; color:#64748b;">
            注 砖 专  : <b id="targetPointsDisplay" style="color:#0f172a;">0</b> 拽转.
          </div>
          
          <div class="calc-row">
            <input type="number" id="currentPointsInput" class="calc-input" placeholder=" 拽转 砖  专注?">
          </div>
          <div class="calc-row">
            <select id="strategySelect" class="calc-input">
              <option value="" disabled selected> 爪专 转 专爪 专?</option>
            </select>
            <button class="calc-btn" onclick="calculateStrategy()">砖</button>
          </div>

          <div id="calcResult" class="calc-result">
            <div class="res-text"> 住专 转 专 注 专:</div>
            <div class="res-number" id="ordersNeeded">0</div>
            <div class="res-text" id="strategyNameResult">转</div>
            <div style="margin-top:10px; font-size:0.9rem; color:#666;">
              (住专转  <span id="missingPoints">0</span> 拽转)
            </div>
          </div>
        </section>

        <section class="card videoWrap">
          <iframe id="rankVideo" class="videoFrame" src="" title="Video" allowfullscreen></iframe>
        </section>

        <section class="card">
          <h2 class="sectionTitle">砖 砖</h2>
          <ul id="rankBullets" class="bullets"></ul>
        </section>
      </div>

      <div class="print-only-qr">
        <div class="yt-frame">
           <div class="yt-label">住专拽 </div>
           <img id="printQR" class="yt-qr-img" src="" alt="QR">
        </div>
      </div>
    </div>

    <section class="card tree-card-container">
      <h2 class="sectionTitle no-print"> 注抓</h2>
      <div id="rankTreeMount" class="tree-viz-container"></div>
    </section>
  </main>

  <script src="brand-core.js"></script>
  <script src="data-fixed.js?v=CALC_FIXED_2026"></script>
  <script src="rank-tree.js?v=D3_RENDERER"></script>

  <script>
    let currentRankTarget = 0;

    function getRankId() { return new URLSearchParams(location.search).get("id"); }
    function toEmbedUrl(url) {
       if(!url) return "";
       try { const u = new URL(url); return "https://www.youtube.com/embed/" + (u.hostname.includes("youtu.be")?u.pathname.slice(1):u.searchParams.get("v")); } catch(e){return "";}
    }
    function qrUrl(t) { return `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(t)}`; }

    function initCalculator() {
      const select = document.getElementById("strategySelect");
      select.innerHTML = '<option value="" disabled selected> 爪专 拽?</option>';
      
      if (window.STRATEGIES) {
        window.STRATEGIES.forEach(strat => {
          const opt = document.createElement("option");
          opt.value = strat.points;
          opt.textContent = `${strat.name} (${strat.points} 拽')`;
          select.appendChild(opt);
        });
      }
    }

    function calculateStrategy() {
      const currentVal = document.getElementById("currentPointsInput").value;
      if(currentVal === "") { alert("住 拽 "); return; }
      
      const current = parseFloat(currentVal);
      const stratPoints = parseFloat(document.getElementById("strategySelect").value);
      const stratName = document.getElementById("strategySelect").options[document.getElementById("strategySelect").selectedIndex].text;

      if(isNaN(stratPoints)) { alert("专 爪专"); return; }

      const missing = Math.max(0, currentRankTarget - current);
      const needed = Math.ceil(missing / stratPoints);

      document.getElementById("missingPoints").textContent = missing.toLocaleString();
      document.getElementById("ordersNeeded").textContent = needed;
      document.getElementById("strategyNameResult").textContent = stratName.split('(')[0]; // 爪 专拽 转 砖  拽
      
      document.getElementById("calcResult").style.display = "block";
    }

    function initRankPage() {
      const id = getRankId();
      const rank = (window.RANKS || []).find(r => r.id === id);
      
      // 转 转驻专 注
      const nav = document.getElementById("rankNav");
      if(window.RANKS && nav) {
          nav.innerHTML = "";
          window.RANKS.forEach(r => {
              const a = document.createElement("a");
              a.className = "nav-chip";
              if(r.id===id) a.classList.add("active");
              a.href = `rank.html?id=${r.id}`;
              a.textContent = r.nodeCode || r.title;
              nav.appendChild(a);
          });
      }

      if(!rank) { document.getElementById("rankTitle").textContent = " 爪"; return; }

      document.title = rank.title;
      document.getElementById("rankTitle").textContent = rank.title;
      document.getElementById("rankIntro").textContent = rank.intro;
      
      //  -QR
      document.getElementById("rankVideo").src = toEmbedUrl(rank.videoUrl);
      if(document.getElementById("printQR")) document.getElementById("printQR").src = qrUrl(rank.videoUrl);

      // 砖
      if(rank.targetPoints) {
          currentRankTarget = rank.targetPoints;
          document.getElementById("targetPointsDisplay").textContent = currentRankTarget.toLocaleString();
          initCalculator();
      } else {
          document.getElementById("calculatorSection").style.display = "none";
      }

      // 
      const ul = document.getElementById("rankBullets");
      ul.innerHTML = "";
      (rank.bullets||[]).forEach(t => {
          const li = document.createElement("li");
          li.textContent = t;
          ul.appendChild(li);
      });
    }

    document.addEventListener("DOMContentLoaded", initRankPage);
  </script>
</body>
</html>
