<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>专 砖</title>
  <link rel="stylesheet" href="style.css?v=TREE_FIX" />
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    /* 注爪 砖 */
    .calc-card {
      background: #f0f9ff;
      border: 2px solid #bae6fd;
      padding: 25px;
      margin-top: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.05);
    }
    .calc-header { font-size: 1.3rem; font-weight: 800; color: #0369a1; margin-bottom: 10px; }
    .calc-row { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
    .calc-input { flex: 1; padding: 12px; border: 1px solid #94a3b8; border-radius: 8px; font-size: 1rem; }
    .calc-btn { 
      background: #0284c7; color: white; padding: 12px 25px; 
      border: none; border-radius: 8px; font-weight: bold; cursor: pointer;
    }
    .calc-result { 
      background: #ffffff; border: 1px solid #e2e8f0; color: #0f172a;
      padding: 20px; border-radius: 8px; display: none; text-align: center; margin-top: 15px;
    }
    .res-big { font-size: 2.5rem; font-weight: 900; color: #0284c7; line-height: 1.1; margin: 10px 0; }
  </style>
</head>

<body>
  <header class="topbar">
    <div class="topbar-inner">
      <div class="brand-left">
        <a class="btn ghost" href="index.html">专 专砖</a>
        <a class="btn primary" href="products.html" style="background-color:#ff6b00; margin-right:10px;">爪专 </a>
      </div>
      <div class="brand-center">
        <div class="brand-title">住注 砖转祝 砖</div>
      </div>
    </div>
  </header>

  <main class="container">
    <nav class="rank-nav-container">
      <div class="rank-nav-label">专 专:</div>
      <div id="rankNav" class="rank-nav-buttons"></div>
    </nav>

    <div id="rankPrintLayout">
      <div class="rank-text-area">
        <section class="card">
          <h1 id="rankTitle" class="rankTitle">注...</h1>
          <p id="rankIntro" class="rankIntro"></p>
        </section>

        <section class="calc-card no-print" id="calculatorSection">
          <div class="calc-header">М 砖 住专</div>
          <div style="margin-bottom:10px;">注 专 : <b id="targetPointsDisplay">0</b> 拽转.</div>
          
          <div class="calc-row">
            <input type="number" id="currentPointsInput" class="calc-input" placeholder=" 拽转 砖  专注?">
          </div>
          <div class="calc-row">
            <select id="strategySelect" class="calc-input">
              <option value="" disabled selected>专 ...</option>
            </select>
            <button class="calc-btn" onclick="calculateStrategy()">砖</button>
          </div>

          <div id="calcResult" class="calc-result">
            <div> 住专 转 专 住专  <b id="missingPoints">0</b> 拽转.</div>
            <div> 专 砖爪专 专 注:</div>
            <div class="res-big" id="ordersNeeded">0</div>
            <div id="strategyNameResult">转</div>
          </div>
        </section>

        <section class="card videoWrap">
          <iframe id="rankVideo" class="videoFrame" src="" title="Video" allowfullscreen></iframe>
        </section>

        <section class="card">
          <h2 class="sectionTitle">砖 砖</h2>
          <ul id="rankBullets" class="bullets"></ul>
        </section>
      </div>

      <div class="print-only-qr">
        <div class="yt-frame">
           <div class="yt-label">住专拽 </div>
           <img id="printQR" class="yt-qr-img" src="" alt="QR">
        </div>
      </div>
    </div>

    <section class="card tree-card-container">
      <h2 class="sectionTitle no-print"> 注抓</h2>
      <div id="rankTreeMount" class="tree-viz-container"></div>
    </section>
  </main>

  <script src="brand-core.js"></script>
  <script src="data.js?v=TREE_FIX"></script>
  <script src="rank-tree.js?v=D3_RENDERER"></script>

  <script>
    let currentRankTarget = 0;

    function getRankId() { return new URLSearchParams(location.search).get("id"); }
    function toEmbedUrl(url) {
       if(!url) return "";
       try { const u = new URL(url); return "https://www.youtube.com/embed/" + (u.hostname.includes("youtu.be")?u.pathname.slice(1):u.searchParams.get("v")); } catch(e){return "";}
    }
    function qrUrl(t) { return `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(t)}`; }

    function initCalculator() {
      const select = document.getElementById("strategySelect");
      select.innerHTML = '<option value="" disabled selected>专 ...</option>';
      if (window.STRATEGIES) {
        window.STRATEGIES.forEach(strat => {
          const opt = document.createElement("option");
          opt.value = strat.points;
          opt.textContent = `${strat.name}`;
          select.appendChild(opt);
        });
      }
    }

    function calculateStrategy() {
      const current = parseFloat(document.getElementById("currentPointsInput").value);
      const stratPoints = parseFloat(document.getElementById("strategySelect").value);
      const selIndex = document.getElementById("strategySelect").selectedIndex;
      
      let stratName = "转";
      if(selIndex > 0) {
         stratName = window.STRATEGIES[selIndex-1].name; 
      }

      if(isNaN(current) || isNaN(stratPoints)) { alert("  转 转拽"); return; }

      const missing = Math.max(0, currentRankTarget - current);
      const needed = Math.ceil(missing / stratPoints);

      document.getElementById("missingPoints").textContent = missing.toLocaleString();
      document.getElementById("ordersNeeded").textContent = needed;
      document.getElementById("strategyNameResult").textContent = "砖 " + stratName;
      document.getElementById("calcResult").style.display = "block";
      
      if (missing <= 0) { document.getElementById("ordersNeeded").textContent = "注 砖! "; }
    }

    function initRankPage() {
      const id = getRankId();
      const rank = (window.RANKS || []).find(r => r.id === id);
      
      const nav = document.getElementById("rankNav");
      if(nav && window.RANKS) {
        nav.innerHTML = "";
        window.RANKS.forEach(r => {
            const a = document.createElement("a");
            a.className = "nav-chip";
            if(r.id===id) a.classList.add("active");
            a.href = `rank.html?id=${r.id}`;
            a.textContent = r.nodeCode || r.title;
            nav.appendChild(a);
        });
      }

      if(!rank) { document.getElementById("rankTitle").textContent = " 爪"; return; }

      document.title = rank.title;
      document.getElementById("rankTitle").textContent = rank.title;
      document.getElementById("rankIntro").textContent = rank.intro;
      document.getElementById("rankVideo").src = toEmbedUrl(rank.videoUrl);
      if(document.getElementById("printQR")) document.getElementById("printQR").src = qrUrl(rank.videoUrl);

      // 驻注转 砖  砖 注
      if(rank.targetPoints) {
          currentRankTarget = rank.targetPoints;
          document.getElementById("targetPointsDisplay").textContent = currentRankTarget.toLocaleString();
          initCalculator();
          document.getElementById("calculatorSection").style.display = "block";
      } else {
          document.getElementById("calculatorSection").style.display = "none";
      }

      const ul = document.getElementById("rankBullets");
      ul.innerHTML = "";
      (rank.bullets||[]).forEach(t => {
          const li = document.createElement("li");
          li.textContent = t;
          ul.appendChild(li);
      });
    }

    document.addEventListener("DOMContentLoaded", initRankPage);
  </script>
</body>
</html>
