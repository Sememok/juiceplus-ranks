<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>חוברת להדפסה</title>
  <link rel="stylesheet" href="style.css" />
</head>

<body class="print-booklet">
  <header class="topbar print-hide">
    <div class="topbar-inner">
      <div class="brand-left">
        <img data-brand="logo" class="brand-logo" alt="לוגו" style="display:none">
        <div class="brand-text">
          <div data-brand="groupName" class="brand-title">המסע המשותף שלנו</div>
          <div data-brand="tagline" class="brand-subtitle">חוברת הדרגות – להדפסה</div>
        </div>
      </div>
      <div class="actions">
        <a class="btn" href="index.html">חזרה</a>
        <button class="btn btn-green" onclick="window.print()">הדפס / שמירה כ-PDF</button>
      </div>
    </div>
  </header>

  <main class="container booklet">
    <section class="card booklet-cover">
      <div style="text-align:center;">
        <img data-brand="logo" alt="לוגו" style="max-width:150px; margin-bottom:20px; display:none">
        <h1 class="cover-title" style="font-size:3em; margin:0;">חוברת דרגות דיגיטלית</h1>
        <p class="muted" style="font-size:1.5em; margin-top:10px;">
          מדריך וידאו, עצי התקדמות וטיפים לזכיין
        </p>
      </div>
      <div class="print-note muted" style="text-align:center; margin-top:50px;">
        נוצר באופן דיגיטלי. סרוק את ה-QR לצפייה.
      </div>
    </section>

    <div id="bookletPages"></div>
  </main>

  <script src="brand-core.js"></script>
  <script src="data.js"></script>
  <script>
    const pagesRoot = document.getElementById("bookletPages");
    pagesRoot.innerHTML = "";

    function qrUrl(text){
      const t = encodeURIComponent(text || "");
      return `https://chart.googleapis.com/chart?cht=qr&chs=150x150&chld=M|0&chl=${t}`;
    }

    function escapeHtml(str) {
      return (str || "").replace(/[&<>"']/g, m => ({
        "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#039;"
      }[m]));
    }
    
    // פונקציה פשוטה לציור עץ בחוברת ללא תלות בקובץ החיצוני
    function renderSimpleTree(tree, containerId) {
        if(!tree) return;
        const div = document.createElement("div");
        div.className = "treeCanvas";
        // פריסה פשוטה
        div.style.setProperty("--cols", "3");
        
        const layer = document.createElement("div");
        layer.className = "treeNodesLayer";
        
        tree.nodes.forEach(n => {
            const node = document.createElement("div");
            node.className = "treeNode";
            if(n.id === tree.highlightId) node.classList.add("isHere");
            node.style.gridRow = (n.generation||0) + 1;
            node.style.gridColumn = (n.column||0) + 1;
            
            node.innerHTML = `
                <div class="treeNodeTop">
                    <div class="treeBadge">${n.code||""}</div>
                    <div class="treeLabel">${n.label||""}</div>
                </div>
                ${n.pv ? `<div class="treeMeta">PV: <b>${n.pv}</b></div>` : ""}
            `;
            layer.appendChild(node);
        });
        
        div.appendChild(layer);
        
        // הערות
        if (tree.notes && tree.notes.length) {
            const notes = document.createElement("div");
            notes.className = "treeNotes";
            notes.innerHTML = `<div class="treeNotesTitle">הערות:</div><ul>${tree.notes.map(t=>`<li>${t}</li>`).join("")}</ul>`;
            div.appendChild(notes);
        }

        document.getElementById(containerId).appendChild(div);
    }

    if (Array.isArray(window.RANKS)) {
      window.RANKS.forEach((rank, idx) => {
        const page = document.createElement("section");
        page.className = "card booklet-page";
        
        // שימוש במבנה הגריד החדש: טקסט מימין, QR משמאל
        page.innerHTML = `
          <div id="rankPrintLayout" style="border:none; margin-bottom:10px;">
            <div class="rank-text-area">
               <div style="font-size:0.8em; color:#666">דף דרגה ${idx + 1}</div>
               <h2 class="rankTitle" style="font-size:1.6em; margin:0;">${escapeHtml(rank.title)}</h2>
               <p class="muted" style="margin-bottom:10px;">${escapeHtml(rank.intro)}</p>
               
               <h3 style="font-size:1.1em; margin:5px 0;">נקודות מפתח:</h3>
               <ul class="bullets">
                 ${(rank.bullets || []).map(b => `<li>${escapeHtml(b)}</li>`).join("")}
               </ul>
            </div>

            <div class="print-only-qr" style="display:flex !important; justify-content:flex-end;">
              <div class="yt-frame">
                <div class="yt-label">סרטון הדרכה</div>
                <img class="yt-qr-img" src="${qrUrl(rank.videoUrl)}" alt="QR">
                <div class="yt-sub">סרוק לצפייה</div>
              </div>
            </div>
          </div>

          <div style="margin-top:0;">
            <h3 class="sectionTitle" style="font-size:1.2em;">מבנה והתקדמות</h3>
            <div id="tree_booklet_${idx}"></div>
          </div>
          
          <div style="position:absolute; bottom:10px; left:0; right:0; text-align:center; font-size:9pt; color:#999; border-top:1px solid #eee; padding-top:5px;">
             המסע המשותף שלנו • Juice Plus+
          </div>
        `;
        pagesRoot.appendChild(page);

        // Render tree if available
        if(window.RANK_TREES && window.RANK_TREES[rank.id]) {
            renderSimpleTree(window.RANK_TREES[rank.id], `tree_booklet_${idx}`);
        }
      });
    }
  </script>
</body>
</html>
