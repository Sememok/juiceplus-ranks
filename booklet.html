<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>חוברת להדפסה</title>
  <link rel="stylesheet" href="style.css" />
</head>

<body class="print-booklet">
  <header class="topbar print-hide">
    <div class="topbar-inner">
      <div class="brand-left">
        <img id="brandLogo" class="brand-logo" alt="לוגו" />
        <div class="brand-text">
          <div id="brandGroupName" class="brand-title">המסע המשותף שלנו</div>
          <div id="brandTagline" class="brand-subtitle">חוברת הדרגות – להדפסה</div>
        </div>
      </div>

      <div class="actions">
        <a class="btn" href="index.html">חזרה</a>
        <button class="btn btn-green" onclick="window.print()">הדפס / שמירה כ-PDF</button>
      </div>
    </div>
  </header>

  <!-- DEBUG BOX: יראה לך למה QR לא מופיע -->
  <section id="debugBox" class="card debug print-hide" style="display:none"></section>

  <main class="container booklet">
    <section class="card booklet-cover">
      <div class="cover-row">
        <div>
          <h1 class="cover-title">חוברת דרגות דיגיטלית</h1>
          <p class="muted">
            בכל עמוד דרגה: הסבר קצר, QR לסרטון, ועץ התקדמות.
          </p>
        </div>
        <div class="cover-logo">
          <img id="coverLogo" alt="לוגו" />
        </div>
      </div>
      <div class="print-note muted">טיפ: בדפדפן לחץ Print ואז “Save as PDF”.</div>
    </section>

    <div id="bookletPages"></div>
  </main>

  <!-- חשוב: סדר טעינה -->
  <script src="brand-core.js"></script>
  <script src="data.js"></script>
  <script src="rank-tree.js"></script>

  <script>
    // ===== Debug helper =====
    function showDebug(lines){
      const box = document.getElementById("debugBox");
      box.style.display = "block";
      box.innerHTML = `
        <h3 style="margin-top:0">בדיקת טעינה (Debug)</h3>
        <ul style="margin:0; padding-right:18px">
          ${lines.map(l => `<li>${escapeHtml(l)}</li>`).join("")}
        </ul>
        <div class="muted" style="margin-top:8px">
          אם אתה רואה כאן שגיאה, צלם מסך ושלח לי.
        </div>
      `;
    }

    // ===== Brand =====
    try {
      if (typeof brandRender === "function") brandRender();
      const coverLogo = document.getElementById("coverLogo");
      const brandLogo = document.getElementById("brandLogo");
      setTimeout(() => { if (coverLogo) coverLogo.src = (brandLogo && brandLogo.src) ? brandLogo.src : ""; }, 0);
    } catch (e) {
      showDebug([`שגיאה ב-brandRender: ${e.message}`]);
    }

    // ===== Validate data =====
    const debug = [];
    if (!window.RANKS) debug.push("window.RANKS לא נטען. בדוק ש-data.js קיים ושלא שינית לו שם.");
    else if (!Array.isArray(window.RANKS)) debug.push("window.RANKS נטען אבל אינו מערך (Array). בדוק את data.js.");
    else if (window.RANKS.length === 0) debug.push("window.RANKS הוא מערך ריק – אין דרגות להצגה.");
    else debug.push(`RANKS נטען: ${window.RANKS.length} דרגות.`);

    if (typeof window.renderRankTree !== "function") {
      debug.push("renderRankTree לא קיים. rank-tree.js לא נטען או יש בו שגיאה.");
    } else {
      debug.push("rank-tree.js נטען: renderRankTree זמין.");
    }

    // אם יש בעיות – להציג debug ולהמשיך בכל זאת
    if (debug.some(x => x.includes("לא"))) showDebug(debug);

    // ===== Build pages =====
    const pagesRoot = document.getElementById("bookletPages");
    pagesRoot.innerHTML = "";

    if (Array.isArray(window.RANKS)) {
      window.RANKS.forEach((rank, idx) => {
        const page = document.createElement("section");
        page.className = "card booklet-page";
        page.innerHTML = `
          <div class="page-header">
            <div>
              <div class="page-kicker">דף דרגה ${idx + 1} מתוך ${window.RANKS.length}</div>
              <h2 class="page-title">${escapeHtml(rank.title || "")}</h2>
              <p class="muted">${escapeHtml(rank.intro || "")}</p>
            </div>

            <div class="qr-block">
              <div class="qr-title">סריקה לסרטון</div>
              <div class="qr-img-wrap">
                <img
                  class="qr-img"
                  alt="QR לסרטון"
                  src="${qrUrl(rank.videoUrl)}"
                  onerror="this.closest('.qr-block').querySelector('.qr-error').style.display='block';"
                />
              </div>
              <div class="qr-error muted" style="display:none; margin-top:8px;">
                QR לא נטען. בדוק חיבור אינטרנט / חסימת רשת / כתובת סרטון.
              </div>
              <div class="qr-url muted">${escapeHtml(rank.videoUrl || "")}</div>
            </div>
          </div>

          <div class="page-section">
            <h3>מה חשוב ללמוד בדרגה הזו</h3>
            <ul class="bullets">
              ${(rank.bullets || []).map(b => `<li>${escapeHtml(b)}</li>`).join("")}
            </ul>
          </div>

          <div class="page-section">
            <h3>עץ התקדמות (דורות + נקודות)</h3>
            <div id="tree_${escapeId(rank.id)}"></div>
          </div>

          <div class="page-footer muted">המסע המשותף שלנו • חוברת להדפסה</div>
        `;
        pagesRoot.appendChild(page);

        // Tree render (אם קיים)
        try {
          if (typeof window.renderRankTree === "function") {
            window.renderRankTree({
              rankKey: rank.title,
              containerId: `tree_${rank.id}`,
              currentNodeCode: rank.nodeCode,
              title: ""
            });
          }
        } catch (e) {
          showDebug([`שגיאה ב-renderRankTree עבור ${rank.title}: ${e.message}`].concat(debug));
        }
      });
    }

    function qrUrl(text){
      // Google Chart QR - יציב מאוד, טוב להדפסה
      const t = encodeURIComponent(text || "");
      return `https://chart.googleapis.com/chart?cht=qr&chs=220x220&chld=M|1&chl=${t}`;
    }

    function escapeHtml(str) {
      return (str || "").replace(/[&<>"']/g, (m) => ({
        "&": "&amp;",
        "<": "&lt;",
        ">": "&gt;",
        '"': "&quot;",
        "'": "&#039;"
      }[m]));
    }
    function escapeId(str){
      return String(str || "").replace(/[^a-zA-Z0-9_-]/g, "_");
    }
  </script>
</body>
</html>
